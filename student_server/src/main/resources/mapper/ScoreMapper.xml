<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.auggie.student_server.mapper.ScoreMapper">

    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO studentms.score (
            student_id, course_id, teacher_id, term,
            usual_score, mid_score, final_score, grade, remark, status
        ) VALUES (
            #{studentId}, #{courseId}, #{teacherId}, #{term},
            #{usualScore}, #{midScore}, #{finalScore}, #{grade}, #{remark}, #{status}
        )
    </insert>

    <insert id="batchInsert">
        INSERT INTO studentms.score (
            student_id, course_id, teacher_id, term,
            usual_score, mid_score, final_score, grade, remark, status
        ) VALUES
        <foreach collection="list" item="s" separator=",">
            (#{s.studentId}, #{s.courseId}, #{s.teacherId}, #{s.term},
             #{s.usualScore}, #{s.midScore}, #{s.finalScore}, #{s.grade}, #{s.remark}, #{s.status})
        </foreach>
    </insert>

    <update id="updateById">
        UPDATE studentms.score SET
            usual_score = #{usualScore},
            mid_score = #{midScore},
            final_score = #{finalScore},
            grade = #{grade},
            remark = #{remark},
            status = #{status},
            teacher_id = #{teacherId}
        WHERE id = #{id}
    </update>

    <select id="findById" resultType="Score">
        SELECT id, student_id AS studentId, course_id AS courseId, teacher_id AS teacherId,
               term, usual_score AS usualScore, mid_score AS midScore, final_score AS finalScore,
               grade, remark, status, created_at AS createdAt, updated_at AS updatedAt
        FROM studentms.score WHERE id = #{id}
    </select>

    <select id="findByStudentCourseTerm" resultType="Score">
        SELECT id, student_id AS studentId, course_id AS courseId, teacher_id AS teacherId,
               term, usual_score AS usualScore, mid_score AS midScore, final_score AS finalScore,
               grade, remark, status, created_at AS createdAt, updated_at AS updatedAt
        FROM studentms.score
        WHERE student_id = #{studentId} AND course_id = #{courseId} AND term = #{term}
    </select>

    <select id="findBySearch" resultType="Score">
        SELECT s.id, s.student_id AS studentId, s.course_id AS courseId, s.teacher_id AS teacherId,
               s.term, s.usual_score AS usualScore, s.mid_score AS midScore, s.final_score AS finalScore,
               s.grade, s.remark, s.status, s.created_at AS createdAt, s.updated_at AS updatedAt
        FROM studentms.score s
        LEFT JOIN studentms.course c ON s.course_id = c.id
        <where>
            <if test="studentId != null">AND s.student_id = #{studentId}</if>
            <if test="courseId != null">AND s.course_id = #{courseId}</if>
            <if test="term != null and term != ''">AND s.term = #{term}</if>
            <if test="status != null and status != ''">AND s.status = #{status}</if>
            <if test="teacherId != null">AND s.teacher_id = #{teacherId}</if>
            <if test="departmentId != null">AND c.department_id = #{departmentId}</if>
        </where>
        ORDER BY s.term DESC, s.id
    </select>

    <select id="findScoreIdsByTermCourse" resultType="int">
        SELECT id FROM studentms.score
        WHERE term = #{term} AND course_id = #{courseId}
    </select>

    <select id="findScoreQueryBySearch" resultType="ScoreQueryDTO">
        SELECT s.id, s.student_id AS studentId, s.course_id AS courseId, s.teacher_id AS teacherId,
               s.term, s.usual_score AS usualScore, s.mid_score AS midScore, s.final_score AS finalScore,
               s.grade, s.remark, s.status,
               s.created_at AS createdAt, s.updated_at AS updatedAt,
               st.student_no AS studentNo, st.sname, c.cname, t.tname, t.tname AS teacherRealName,
               c.department_id AS departmentId, d.name AS departmentName,
               st.major_id AS majorId, m.name AS majorName, st.class_id AS classId, cls.name AS className,
               st.grade_level_id AS gradeLevelId, gl.name AS gradeLevel, c.ccredit AS credit
        FROM studentms.score s
        LEFT JOIN studentms.student st ON s.student_id = st.id
        LEFT JOIN studentms.course c ON s.course_id = c.id
        LEFT JOIN studentms.teacher t ON s.teacher_id = t.id
        LEFT JOIN studentms.department d ON c.department_id = d.id
        LEFT JOIN studentms.major m ON st.major_id = m.id
        LEFT JOIN studentms.class cls ON st.class_id = cls.id
        LEFT JOIN studentms.grade_level gl ON st.grade_level_id = gl.id
        <where>
            <if test="studentId != null">AND s.student_id = #{studentId}</if>
            <if test="courseId != null">AND s.course_id = #{courseId}</if>
            <if test="term != null and term != ''">AND s.term = #{term}</if>
            <if test="status != null and status != ''">AND s.status = #{status}</if>
            <if test="teacherId != null">AND s.teacher_id = #{teacherId}</if>
            <if test="departmentId != null">AND c.department_id = #{departmentId}</if>
            <if test="majorId != null">AND st.major_id = #{majorId}</if>
            <if test="classId != null">AND st.class_id = #{classId}</if>
            <if test="gradeLevelId != null">AND st.grade_level_id = #{gradeLevelId}</if>
            <if test="lowBound != null">AND s.grade &gt;= #{lowBound}</if>
            <if test="highBound != null">AND s.grade &lt;= #{highBound}</if>
        </where>
        ORDER BY s.term DESC, s.id
    </select>

    <select id="findScoreQueryForDean" resultType="ScoreQueryDTO">
        SELECT s.id, s.student_id AS studentId, s.course_id AS courseId, s.teacher_id AS teacherId,
               s.term, s.usual_score AS usualScore, s.mid_score AS midScore, s.final_score AS finalScore,
               s.grade, s.remark, s.status,
               s.created_at AS createdAt, s.updated_at AS updatedAt,
               st.student_no AS studentNo, st.sname, c.cname, t.tname, t.tname AS teacherRealName,
               c.department_id AS departmentId, d.name AS departmentName,
               st.major_id AS majorId, m.name AS majorName, st.class_id AS classId, cls.name AS className,
               st.grade_level_id AS gradeLevelId, gl.name AS gradeLevel, c.ccredit AS credit,
               st.department_id AS studentDepartmentId, sd.name AS studentDepartmentName
        FROM studentms.score s
        LEFT JOIN studentms.student st ON s.student_id = st.id
        LEFT JOIN studentms.course c ON s.course_id = c.id
        LEFT JOIN studentms.teacher t ON s.teacher_id = t.id
        LEFT JOIN studentms.department d ON c.department_id = d.id
        LEFT JOIN studentms.department sd ON st.department_id = sd.id
        LEFT JOIN studentms.major m ON st.major_id = m.id
        LEFT JOIN studentms.class cls ON st.class_id = cls.id
        LEFT JOIN studentms.grade_level gl ON st.grade_level_id = gl.id
        <where>
            <if test="courseDepartmentId != null">AND c.department_id = #{courseDepartmentId}</if>
            <if test="courseId != null">AND s.course_id = #{courseId}</if>
            <if test="term != null and term != ''">AND s.term = #{term}</if>
            <if test="status != null and status != ''">AND s.status = #{status}</if>
            <if test="studentId != null">AND s.student_id = #{studentId}</if>
            <if test="studentNo != null and studentNo != ''">AND st.student_no LIKE CONCAT('%', #{studentNo}, '%')</if>
            <if test="studentName != null and studentName != ''">AND st.sname LIKE CONCAT('%', #{studentName}, '%')</if>
            <if test="studentCollegeId != null">AND st.department_id = #{studentCollegeId}</if>
            <if test="studentMajorId != null">AND st.major_id = #{studentMajorId}</if>
            <if test="studentClassId != null">AND st.class_id = #{studentClassId}</if>
            <if test="lowBound != null">AND s.grade &gt;= #{lowBound}</if>
            <if test="highBound != null">AND s.grade &lt;= #{highBound}</if>
        </where>
        ORDER BY s.term DESC, s.id
    </select>
</mapper>
