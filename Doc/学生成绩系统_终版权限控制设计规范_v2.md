# 学生成绩管理系统 · 终版权限控制设计规范（新系统版）

> 本文档基于当前 studentms.sql 数据库结构重新设计，不考虑旧系统兼容性。  
> 目标：统一“成绩上传 + 审批发布 + 修改申请 + 全流程留痕”，并明确公共课与权限边界。

---

## 一、系统核心原则（必须遵守）

### 1️⃣ 基础数据强管控
以下数据 **只能由系统管理员(admin)** 维护：

- 学院（department）
- 专业（major）
- 班级（class）
- 学生（student）
- 教师（teacher）
- 课程（course）
- 开课安排（course_open）

👉 教师、院长：**无任何基础数据维护权限**。

---

### 2️⃣ 成绩分层管理原则

系统必须拆成三层：

| 层级 | 表 | 说明 |
|------|----|------|
成绩事实层 | score | 当前系统对外展示的唯一有效成绩  
流程控制层 | grade_change_request | 所有修改申请  
审计追溯层 | grade_change_log | 不可删除、不可修改  

👉 所有成绩变动，必须留下痕迹。

---

### 3️⃣ 公共课核心规则

> 公共课只是“学生范围公共”，不是“管理权公共”。

权限判断**永远只看课程归属学院**：

```text
course.department_id = 谁的学院 → 谁才有管理权
```

即使全校学生都上，也只允许：
- 开课学院院长
- 任课教师
- 系统管理员

操作。

---

## 二、角色权限模型（终版）

### ✅ admin（系统管理员 / 教务）

拥有最高权限：

- 维护所有基础数据
- 安排每学期开课
- 上传成绩单
- 审核并发布成绩
- 审批成绩修改申请
- 强制更正成绩
- 查看全部日志

👉 系统最终裁决者。

---

### ✅ teacher（教师）

可以做：

- 上传【自己任课课程】成绩单
- 查询自己课程成绩
- 提交成绩修改申请
- 查看本人申请记录

不能做：

- 维护任何基础数据
- 直接修改已发布成绩
- 审核任何人

权限公式：

```sql
exists (
  select 1 from course_open
  where teacher_id = 当前用户
  and course_id = 目标课程
  and term = 当前学期
)
```

---

### ✅ dean（学院管理员）

可以做：

- 上传【本学院课程】成绩单
- 查询本学院所有成绩
- 审核教师成绩修改申请（一级）
- 向系统管理员提交修改审批

不能做：

- 操作非本学院课程
- 维护基础数据
- 直接改成绩

权限公式：

```sql
course.department_id = 当前院长.department_id
```

---

## 三、成绩生命周期设计

### （一）成绩上传流程（教师 / 院长 / 管理员）

```
上传Excel → 校验 → 写入score(状态=草稿) → 生成grade_change_log
           ↓
        管理员审核
           ↓
        发布 → 成绩生效
```

规则：

- 教师：只能上传自己课
- 院长：只能上传本学院课程
- 管理员：可以上传所有

⚠ 上传≠生效，必须管理员确认发布。

---

### （二）成绩修改流程（统一申请制）

任何已发布成绩：

❌ 不允许直接 UPDATE  
✅ 必须走申请流

#### 1️⃣ 提交申请

教师 / 院长填写：

- 学生
- 课程
- 原成绩
- 目标成绩
- 原因
- 证明附件

写入：grade_change_request

状态：PENDING

---

#### 2️⃣ 院长审核（可选）

- 是否同意上报

---

#### 3️⃣ 管理员终审

- 通过 → 修改 score
- 写入 grade_change_log
- 标记申请为 APPROVED

- 拒绝 → 仅修改申请状态

---

## 四、数据表职责重新定义

### score（成绩主表）

只存：

- 学生
- 课程
- 学期
- 成绩值

👉 永远代表：当前有效成绩。

---

### grade_change_request（成绩修改申请）

业务流程表：

- 谁申请
- 改什么
- 为什么
- 审批状态

👉 用于控制流转。

---

### grade_change_log（成绩审计表）

铁律表：

- 不允许删除
- 不允许修改
- 每一次导入、发布、修改都要写

👉 用于：追责、审计、备案、答辩。

---

## 五、关键权限校验点（必须写死）

### ✅ 上传成绩

```text
admin → 放行
teacher → 必须是任课教师
dean → 必须是本学院课程
```

---

### ✅ 查看成绩

- 教师：仅自己课程
- 院长：本学院所有课程
- 管理员：全校

---

### ✅ 修改成绩

❌ 全系统无任何“直接修改”接口  
✅ 只有“申请 + 审批 + 系统执行”

---

## 六、防作死设计（非常重要）

必须做到：

- ❌ 前端禁用
- ❌ 后端拦截
- ❌ 数据库不暴露

所有 UPDATE score 的代码：
👉 只能存在于【管理员审批服务】中。

---

## 七、学生只能查看已经发布的成绩

## 八、Cursor 分阶段改：
第一阶段：数据库结构 + 实体类
第二阶段：导入流程改造
第三阶段：成绩修改申请流
第四阶段：权限拦截 + 前端菜单

