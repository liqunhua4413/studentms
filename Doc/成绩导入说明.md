# 成绩导入说明

本文档说明成绩单批量导入的格式要求、基础数据准备及强校验流程。

---

## 一、成绩单格式

### 1.1 表头结构

成绩单 Excel 使用固定格式，第 2 行和第 3 行为合并单元格，包含以下字段：

**第 2 行**（合并 A–N 列）示例：
```
课程名称：临床检验基础  课程类别：专业课  课程性质：必修  考核方式：考试  任课教师：李老师
```

**第 3 行**（合并 A–N 列）示例：
```
开课学期：2025-2026学年第一学期  学分：4  学时：64  开课班级：24级医学检验技术1班
```

### 1.2 字段说明

| 字段     | 位置 | 说明 | 示例 |
|----------|------|------|------|
| 课程名称 | 第2行 | 必填，与系统课程完全一致 | 临床检验基础 |
| 课程类别 | 第2行 | 必填，与 course.category 一致 | 专业课、公共课 |
| 课程性质 | 第2行 | 必填，与培养方案 course_type 一致 | 必修、限选、任选 |
| 考核方式 | 第2行 | 必填，与 course.exam_method 一致 | 考试、考查 |
| 任课教师 | 第2行 | 必填，与系统教师姓名完全一致，且须在开课表（course_open）中担任该课程该学期的教学任务 | 李老师 |
| 开课学期 | 第3行 | 必填，与 term.name 完全一致，且开课表中须存在该课程该学期的开课记录 | 2025-2026学年第一学期 |
| 学分     | 第3行 | 必填，与 course.ccredit 一致 | 4 |
| 学时     | 第3行 | 必填，与 course.hours 一致 | 64 |
| 开课班级 | 第3行 | 必填，格式为「年级+专业+班级」；年级、专业、班级须在对应表中存在；专业须在培养方案中纳入该课程 | 24级医学检验技术1班 |

### 1.3 开课班级解析规则

「开课班级」为混合字段，系统按以下规则解析：

- **年级**：`xx级` → 解析为 `20xx级`，如 `24级` → `2024级`
- **班级**：`x班` 或 `xx班` → 如 `1班`、`2班`
- **专业**：中间部分，如 `医学检验技术`

示例：`24级医学检验技术1班` → 年级：2024级，专业：医学检验技术，班级：1班

### 1.4 成绩数据行

从第 5 行起为成绩数据，每行包含：学号、姓名、平时成绩、期中成绩、期末成绩、总成绩、备注等。  
若某行首个单元格出现「各档成绩百分比」或「签字」，则其后行不再处理。

---

## 二、现有基础数据模块

| 模块       | 表/实体        | 导入入口 | 说明 |
|------------|----------------|----------|------|
| 学院管理   | department     | 学院批量导入 | 学院名称 |
| 年级学期   | grade_level, term | 年级导入、学期导入 | 新增 |
| 专业管理   | major          | 专业批量导入 | 专业名称、所属学院ID |
| 班级管理   | class          | 班级批量导入 | 班级名称、年级、专业ID、学院ID |
| 教师管理   | teacher        | 教师批量导入 | 工号、姓名、密码、角色、学院ID |
| 课程管理   | course         | 课程批量导入 | 课程名称、学分、课程类别、考核方式、学时、学院ID |
| 教学管理   | course_open    | 批量导入 | 课程ID、教师ID、学期 |
| 学生管理   | student        | 学生批量导入 | 学号、姓名、密码、班级ID、年级、专业ID、学院ID |
| 培养方案   | training_plan  | 暂无单独导入 | 专业-课程关系，课程性质（必修/限选/任选） |

---

## 三、基础数据导入模块设计

### 3.1 导入顺序与依赖

按依赖关系，推荐导入顺序为：

```
1. 学院 → 2. 年级 → 3. 学期 → 4. 专业 → 5. 班级 → 6. 教师 → 7. 课程 → 8. 教学管理（开课）→ 9. 学生
```

Admin 菜单已按此顺序排列：学院管理 → 年级学期 → 专业管理 → 班级管理 → 教师管理 → 课程管理 → 教学管理 → 学生管理 → 成绩管理 → …

### 3.2 年级学期模块

**年级导入模板**  
- 列：年级名称、排序（可选，默认 0）  
- 示例：2024级、1  

**学期导入模板**  
- 列：学期名称、开始日期、结束日期、状态(1启用/0停用)、备注  
- 示例：2025-2026学年第一学期、2025-09-01、2026-01-15、1、2025-2026学年第一学期  

### 3.3 课程性质与培养方案

成绩单中的「课程性质」以 `training_plan.course_type` 为准：

| 成绩单显示 | training_plan.course_type |
|------------|---------------------------|
| 必修       | REQUIRED                  |
| 限选       | LIMITED                   |
| 任选       | ELECTIVE                  |

需在培养方案中维护「专业-课程」关系及课程类型，成绩导入时据此校验课程性质。

---

## 四、成绩单导入强校验流程

### 4.1 阶段一：表头强校验（全部通过才继续）

在解析成绩数据行之前，对表头字段依次校验，任一项失败则整单拒绝：

| 序号 | 字段       | 校验规则 |
|------|------------|----------|
| 1    | 课程名称   | 必须能从文本中解析，且在 course 表中存在 |
| 2    | 课程类别   | 必须与 course.category 一致 |
| 3    | 课程性质   | 若存在培养方案，必须与 training_plan.course_type 对应显示值一致 |
| 4    | 考核方式   | 必须与 course.exam_method 一致 |
| 5    | 任课教师   | 必须在 teacher 表中存在，且在 course_open 中担任该课程该学期的教学任务 |
| 6    | 开课学期   | 必须在 term 表中存在，且 course_open 中须有该课程该学期的开课记录 |
| 7    | 学分       | 必须与 course.ccredit 一致 |
| 8    | 学时       | 必须与 course.hours 一致 |
| 9    | 开课班级   | 解析出年级、专业、班级；年级须在 grade_level 表中存在；专业须在 major 表中存在且培养方案（training_plan）中已纳入该课程；班级须在 class 表中存在 |

### 4.2 阶段二：学生行校验（逐行）

表头校验通过后，对每一行成绩数据：

| 情况 | 处理 |
|------|------|
| 学号为空 | 跳过该行，不报错 |
| 学号在 student 中不存在 | 报错，本行不导入 |
| 学号存在，且 student_id + course_id + term_id 已有成绩 | 视为重复导入，报错，本行不导入 |
| 学号存在且无成绩 | 可导入 |

### 4.3 权限校验

- **Admin**：可上传全部课程成绩  
- **院长 (Dean)**：仅可上传本学院（course.department_id）课程  
- **教师 (Teacher)**：仅可上传本人任课（course_open）课程  

---

## 五、校验失败处理策略

| 阶段   | 失败类型       | 处理策略 |
|--------|----------------|----------|
| 表头   | 任一项校验失败 | **整单拒绝**，立即返回第一个错误信息，不导入任何数据 |
| 学生行 | 学号不存在     | 该行**不导入**，记录错误，继续处理其他行 |
| 学生行 | 重复导入       | 该行**不导入**，提示「学号 XXX 本学期本课程成绩已存在，如需修改请提交修改申请」 |
| 学生行 | 全部行均失败   | **整单拒绝**，返回错误列表（最多 20 条） |
| 学生行 | 无有效成绩行   | **整单拒绝**，提示「无有效成绩行」 |

---

## 六、操作建议

1. **首次使用**：按「学院 → 年级 → 学期 → 专业 → 班级 → 教师 → 课程」顺序导入基础数据，再导入成绩单。  
2. **学期名称**：成绩单中的「开课学期」必须与系统中学期名称完全一致（含标点、空格）。  
3. **教师姓名**：任课教师姓名必须与教师表中的姓名完全一致。  
4. **课程性质**：需在培养方案中维护该专业下该课程的课程类型，否则无法校验课程性质。  
5. **开课信息**：任课教师、课程、学期三者组合必须在「教学管理」中已维护开课信息（course_open），否则导入失败。  
6. **专业与培养方案**：专业不按所属学院校验，而是按培养方案校验——该专业必须在培养方案中纳入该课程（如马克思主义学院开设的公共课面向所有专业，专业可属于其他学院）。  
7. **重复导入**：若某学生某课程某学期已有成绩，需通过「成绩修改申请」流程修改，不能再次导入覆盖。

---

*文档版本：1.0 | 更新日期：2026-01-25*
