# 学生成绩管理系统 · 设计方案与部署文档（开发者 / 系统管理员用）

**版本：** v2.0  
**更新日期：** 2026-01-31  
**适用对象：** 开发人员、系统管理员、运维人员  

---

## 一、数据库设计

### 1.1 数据库 ER 图 / 表关系概览

系统采用**教务三层架构**，在数据库中以**四段式结构**落地：

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ 一、课程定义层（资源层）                                                       │
│   department ──┬── major ── class                                            │
│                ├── teacher                                                    │
│                └── course（归属学院，不直接隶属专业）                           │
├─────────────────────────────────────────────────────────────────────────────┤
│ 二、培养方案层（规则层）                                                       │
│   training_plan（专业-课程-版本，必修/限选/任选）                               │
├─────────────────────────────────────────────────────────────────────────────┤
│ 三、教学运行层（业务事实层）                                                   │
│   term ── course_open（课程+教师+学期）── course_open_class（开课-班级）       │
│   student ── score（成绩事实：学号+课程+学期唯一）                              │
├─────────────────────────────────────────────────────────────────────────────┤
│ 四、流程与审计层                                                               │
│   grade_change_request（成绩修改申请）→ grade_change_log（成绩审计日志）        │
│   score_import_record（导入记录）、operation_log（操作日志）                     │
│   exam_paper_analysis（试卷分析文件）                                          │
└─────────────────────────────────────────────────────────────────────────────┘
```

**数据流向：** 课程定义 → 培养方案 → 教学实施（开课）→ 成绩事实 → 修改申请/审计  

**权限边界：** 课程归属学院 `course.department_id`；任课边界 `course_open.teacher_id`；成绩可操作范围 = 成绩关联课程的所属学院。

---

### 1.2 表结构说明（核心表）

#### 基础数据表（仅 admin 维护）

| 表名 | 说明 | 主要字段 | 外键/索引 |
|------|------|----------|-----------|
| department | 学院表 | id, name | name UNIQUE |
| major | 专业表 | id, name, department_id | department_id → department, (name, department_id) UNIQUE |
| grade_level | 年级表 | id, name, sort_order | name UNIQUE |
| class | 班级表 | id, name, grade_level_id, major_id, department_id | major/department/grade_level FK, (name, major_id, department_id) UNIQUE |
| student | 学生表 | id, student_no, sname, password, class_id, grade_level_id, major_id, department_id | student_no UNIQUE, 各 id FK |
| teacher | 教师表 | id, teacher_no, tname, password, role, department_id | teacher_no UNIQUE, role 索引, department_id FK |
| term | 学期表 | id, name, start_date, end_date, status | name UNIQUE |
| course | 课程表（资源层） | id, cname, ccredit, department_id, category, exam_method, hours | department_id FK |
| training_plan | 培养方案表 | id, major_id, course_id, plan_version, course_type, suggested_grade, suggested_term_id, … | (major_id, course_id, plan_version) UNIQUE, 各 FK |
| course_open | 开课表 | id, course_id, teacher_id, term_id | (course_id, teacher_id, term_id) UNIQUE, 各 FK |
| course_open_class | 开课班级表 | id, course_open_id, class_id | (course_open_id, class_id) UNIQUE, 各 FK |

#### 成绩分层设计（score / grade_change_request / grade_change_log）

| 表名 | 作用 | 主要字段 | 说明 |
|------|------|----------|------|
| **score** | 成绩事实表（当前有效成绩） | id, student_id, course_id, teacher_id, term_id, usual_score, mid_score, final_score, grade, **status**, created_at, updated_at | status：UPLOADED / PUBLISHED / LOCKED；学号+课程+学期唯一；(student_id, course_id, term_id) UNIQUE |
| **grade_change_request** | 成绩修改申请表（流程控制） | id, score_id, applicant_id, applicant_role, reason, before_data(JSON), after_data(JSON), **status**, dean_approver_id, admin_approver_id, reject_reason, created_at, updated_at | status：PENDING / DEAN_APPROVED / APPROVED / REJECTED；禁止直接改 score，只能通过申请+审批 |
| **grade_change_log** | 成绩审计表（只追加，不可删改） | id, score_id, operation, operator_id, operator_name, before_json, after_json, created_at | operation：IMPORT / PUBLISH / CHANGE / REQUEST；用于追溯每次成绩变更 |

**成绩状态流转：**

- **UPLOADED（已上传）**：教师/院长/管理员上传成绩单后写入，学生不可见。
- **PUBLISHED（已发布）**：管理员在「发布成绩」中将 UPLOADED → PUBLISHED，学生可见；仅此状态可提交成绩修改申请。
- **LOCKED（锁定）**：管理员可将 PUBLISHED → LOCKED，锁定后仅管理员可强制修正（reexamination）。

**审批流：** 教师/院长提交申请 → PENDING → 院长一级审批（可选）→ DEAN_APPROVED → 管理员终审 → APPROVED（更新 score + 写 grade_change_log）/ REJECTED。

---

### 1.3 辅助表

| 表名 | 说明 |
|------|------|
| score_import_record | 成绩单导入记录（文件名、路径、学期、课程、教师、学院、操作人、状态、说明） |
| operation_log | 操作日志（操作者、操作类型、目标表、目标 id、内容、时间） |
| exam_paper_analysis | 试卷分析文件（文件名、路径、上传人、角色、上传时间） |
| teacher_assignment_history | 教师职务/部门变动历史（可选） |
| student_status_history | 学生学籍变动历史（可选） |

---

## 二、不同用户权限设计

### 2.1 角色与权限矩阵

| 角色 | 登录方式 | 基础数据维护 | 成绩上传 | 成绩查看 | 成绩发布/锁定 | 成绩修改申请 | 审批 | 试卷分析上传 | 操作日志 |
|------|----------|--------------|----------|----------|----------------|--------------|------|--------------|----------|
| **admin** | 工号+密码 | 全部（学院/专业/班级/学生/教师/课程/开课/培养方案等） | 全部课程 | 全部 | 可发布、可锁定 | 可提交 | 管理员终审 | 可 | 可查看全部 |
| **dean** | 工号+密码 | 仅查看 | 仅本学院课程 | 仅本院 | 不可 | 可提交本院课程 | 院长一级审批（本院） | 可 | 可查看本院 |
| **teacher** | 工号+密码 | 仅查看 | 仅本人任课课程 | 仅本人任课 | 不可 | 可提交本人任课 | 不可 | 可 | 可查看本人 |
| **student** | 学号+密码 | 不可 | 不可 | 仅本人、仅 PUBLISHED | 不可 | 不可 | 不可 | 不可 | 不可 |

### 2.2 上传、查看、修改权限细则

- **成绩上传**：admin 选学院后上传；dean 自动限定本院；teacher 自动限定本人任课（course_open）。
- **成绩查看**：学生仅能查 `status = PUBLISHED` 的成绩；教师/院长/管理员按权限过滤课程。
- **成绩修改**：禁止直接改 score 表；只能通过「成绩修改申请」流程，且仅当 score.status = PUBLISHED 时可申请。

### 2.3 审批流控制（grade_change_request）

```
教师/院长提交申请
       ↓
   status = PENDING
       ↓
院长一级审批（可选）── 拒绝 → REJECTED
       ↓ 通过
   status = DEAN_APPROVED
       ↓
管理员终审 ── 拒绝 → REJECTED
       ↓ 通过
   status = APPROVED → 更新 score 表 + 写 grade_change_log
```

说明：当前实现中管理员终审接口仅校验 PENDING；若启用院长一级审批，需支持管理员对 DEAN_APPROVED 的终审。

---

## 三、成绩单批量导入及解析设计

### 3.1 文件存储路径

- **配置项**：`application.yml` 中 `file.upload.path`，默认 `${user.home}/studentms/uploads`。
- **成绩单子目录**：`{uploadPath}/grade_excel/`，文件名：`UUID + 原扩展名`（如 `.xlsx`）。
- **导入记录**：表 `score_import_record` 存 file_name、file_path、term_id、course_id、teacher_id、department_id、operator、status、message。

### 3.2 Excel 字段映射与表头结构

成绩单为**固定格式**：第 2、3 行为合并单元格表头，第 5 行起为数据行。

| Excel 位置 | 内容示例 | 映射/校验 |
|------------|----------|-----------|
| 第 2 行 | 课程名称：临床检验基础 课程类别：专业课 课程性质：必修 考核方式：考试 任课教师：李老师 | 解析后与 course、training_plan、teacher、course_open 校验 |
| 第 3 行 | 开课学期：2024-2025-1 学分：4 学时：64 开课班级：24级医学检验技术1班 | term.name、course.ccredit/hours、解析班级→年级+专业+班级 |
| 第 5 行起 | 学号、姓名、平时成绩、期中成绩、期末成绩、总成绩、备注 | 学号→student；成绩写入 score（usual_score, mid_score, final_score, grade） |

若某行首列出现「各档成绩百分比」或「签字」，则其后行不再处理。

### 3.3 校验规则

- **表头阶段**：课程名称、课程类别、课程性质、考核方式、任课教师、开课学期、学分、学时、开课班级均必填且与系统数据一致；任课教师须在 course_open 中担任该课程该学期；开课班级解析出年级、专业、班级须在 grade_level、major、class 中存在，且专业在 training_plan 中已纳入该课程。
- **数据行**：学号必填且须在 student 中存在；学号+课程+学期在 score 中已存在则拒绝该行（提示提交修改申请）；成绩数值合法性（如 0–100）。
- **权限**：admin 可选学院；dean 仅本院；teacher 仅本人任课。

### 3.4 导入失败处理

| 阶段 | 失败类型 | 处理 |
|------|----------|------|
| 表头 | 任一项校验失败 | 整单拒绝，返回第一条错误，不写入任何 score |
| 数据行 | 学号不存在 / 重复(学号+课程+学期) | 该行不导入，记录错误，继续其他行 |
| 数据行 | 全部行失败 / 无有效行 | 整单拒绝，返回错误列表（最多 20 条） |

### 3.5 成绩发布与锁定

- **发布**：管理员在「发布成绩」中选择 UPLOADED 的记录，批量将 status 改为 PUBLISHED，并写 grade_change_log（PUBLISH）。
- **锁定**：管理员可将 PUBLISHED 成绩批量改为 LOCKED；锁定后仅管理员可「强制修正」（reexamination），并写 grade_change_log（CHANGE）。

---

## 四、试卷分析上传设计

### 4.1 文件存储路径

- **根路径**：同上 `file.upload.path`。
- **子目录**：`{uploadPath}/wordpaper/`，文件名：`UUID + 原扩展名`。
- **数据库**：表 `exam_paper_analysis`（代码中实体为 WordPaper），字段：file_name, file_path, upload_by, uploader_role, upload_time。

### 4.2 上传权限

- **教师**：可上传，upload_by 为当前教师姓名。
- **管理员**：可上传；可删除任意记录（/paper/deleteById 仅 admin，见 AdminInterceptor）。

### 4.3 查看与下载流程

- 教师：可查看本人上传列表（按 upload_by 过滤）。
- 院长：可查看本学院教师上传（按 teacher.department_id 关联 upload_by = tname）。
- 管理员：可查看全部；下载时根据 file_path 读文件返回流。

---

## 五、数据库 / 前端 / 后端改动示例流程

### 5.1 示例场景一：新增成绩（上传成绩单）

| 步骤 | 层次 | 说明 |
|------|------|------|
| 1 | 前端 | 教师/院长/管理员在「上传成绩」页选择学院、选择 Excel，点击上传；请求带 Header：Operator, UserType, DepartmentId |
| 2 | 后端 | GradeController.uploadExcel → GradeUploadService.uploadExcel |
| 3 | Service | 校验权限（admin/dean/teacher）、表头与数据行、学号+课程+学期唯一；写入 score（status=UPLOADED）、score_import_record、grade_change_log(IMPORT) |
| 4 | Mapper | ScoreMapper.insert、ScoreImportRecordMapper.insert、GradeChangeLogMapper 等 |
| 5 | 数据库 | score、score_import_record、grade_change_log 新增记录 |

### 5.2 示例场景二：修改课程（基础数据）

| 步骤 | 层次 | 说明 |
|------|------|------|
| 1 | 前端 | 管理员在课程列表点击「编辑」，提交表单 |
| 2 | 后端 | CourseController 的 update 接口 → CourseService.updateById |
| 3 | Mapper | CourseMapper.updateById |
| 4 | 数据库 | course 表 UPDATE；仅 admin 可操作（AdminInterceptor 限制 /course/update 等） |

### 5.3 示例场景三：上传成绩单（完整链路）

| 步骤 | 层次 | 说明 |
|------|------|------|
| 1 | 前端 | 选择文件 → axios.post('/api/grade/upload', FormData, headers: { Operator, UserType, DepartmentId }) |
| 2 | 后端 | GradeController.uploadExcel → GradeUploadService.uploadExcel：保存文件到 grade_excel 目录、解析 Excel、校验表头与行、插入 score 与日志 |
| 3 | 技术栈 | Spring Boot、MyBatis、Apache POI（Excel）、Vue、ElementUI、axios |

---

## 六、部署说明

### 6.1 软件版本建议

| 软件 | 版本建议 | 说明 |
|------|----------|------|
| Java JDK | 17 | OpenJDK 17 或 Oracle JDK 17 |
| Maven | 3.6+ / 3.9+ | 后端构建 |
| MySQL | 8.0.x | 数据库，建议 utf8mb4 |
| Node.js | 20.x | 前端构建（npm run build） |
| npm | 随 Node 安装 | 前端依赖 |
| Nginx | 最新稳定版 | Linux 生产环境反向代理与静态资源 |

### 6.2 Linux（Ubuntu）部署流程

1. **系统**：Ubuntu Server 22.04 LTS，配置网络、SSH、镜像源（如阿里云）。
2. **安装 Java**：`apt install -y openjdk-17-jdk`，`java -version` 验证。
3. **安装 Maven**：`apt install -y maven`，`mvn -v` 验证。
4. **安装 MySQL**：`apt install -y mysql-server`；修改 root 密码；`mysql -u root -p < studentms.sql` 初始化数据库；`use studentms; show tables;` 验证。
5. **部署后端**：进入 `student_server`，`mvn clean package`；运行 `java -jar target/student_server-0.0.1-SNAPSHOT.jar`（默认端口 10086，context-path /api）。
6. **安装 Nginx**：`apt install -y nginx`，`systemctl start nginx`。
7. **安装 Node**：使用 NodeSource 20.x，`curl -fsSL https://deb.nodesource.com/setup_20.x | sudo bash -`，`apt install -y nodejs`，`node -v` / `npm -v` 验证。
8. **构建前端**：进入 `student_client`，`npm install`，`npm run build`；将 `dist/*` 拷贝到 `/var/www/student/`。
9. **配置 Nginx**：编辑 `/etc/nginx/sites-available/default`，root 指向 `/var/www/student`，`location /api/` 代理到 `http://127.0.0.1:10086`，`try_files $uri $uri/ /index.html` 用于 SPA。
10. **后端开机自启**：systemd 服务 `/etc/systemd/system/student.service`，ExecStart 指向 jar 路径，`systemctl enable student`，`systemctl start student`。

### 6.3 Windows 部署流程（本地/测试）

1. **MySQL**：安装 MySQL 8.x，`mysql -u root -p < studentms.sql`，确认 studentms 库及表存在。
2. **JDK 17**：安装并配置 JAVA_HOME、Path。
3. **Maven**：安装并配置 MAVEN_HOME、Path；`mvn -v` 验证。
4. **后端**：进入 `student_server`，`mvn clean package`；`java -jar target/student_server-0.0.1-SNAPSHOT.jar`；默认 http://localhost:10086/api。
5. **Node**：安装 Node 20.x；进入 `student_client`，`npm install`，`npm run serve`；默认 http://localhost:8080，前端通过 vue.config.js 代理 /api 到 10086。

### 6.4 配置文件说明

| 文件 | 说明 |
|------|------|
| **application.yml** | 数据源 url/username/password、server.port(10086)、context-path(/api)、mybatis、logging、file.upload.path、multipart 大小(50MB) |
| **vue.config.js** | devServer.port(8080)、proxy /api → http://127.0.0.1:10086 |
| **Nginx** | root、index、try_files、location /api/ proxy_pass 与 proxy_set_header |

---

## 七、开发流程

### 7.1 Ubuntu 服务器上开发

- **后端**：修改代码后，`systemctl stop student` → `mvn clean package` → `systemctl start student`；可用 `curl http://127.0.0.1:10086/api/info/getCurrentTerm` 验证。
- **前端**：修改后 `npm run build`，将 `dist/*` 覆盖到 `/var/www/student/`，`nginx -t` 后 `systemctl restart nginx`。

### 7.2 Windows 本地开发

- **后端**：停止当前 jar 进程 → 修改代码 → `mvn clean package` → `java -jar target/student_server-0.0.1-SNAPSHOT.jar`。
- **前端**：修改后直接 `npm run serve`，浏览器访问 http://localhost:8080；若依赖变更需先 `npm install`。

本地开发完成后提交代码，服务器更新后按「七、1」重新编译与部署。

---

## 八、接口文档概要

### 8.1 认证与登录（免鉴权）

| 接口 | 方法 | 功能 | 权限 |
|------|------|------|------|
| /student/login | POST | 学生登录（学号+密码） | 无 |
| /teacher/login | POST | 教师/院长/管理员登录（工号+密码） | 无 |
| /student/findByStudentNo | POST | 按学号查学生（登录后取信息） | 无 |
| /teacher/findByNo | POST | 按工号查教师（登录后取信息） | 无 |

### 8.2 基础数据（部分需 admin）

| 模块 | 典型接口 | 权限 |
|------|----------|------|
| 学院 | /department/findAll, findById；/department/add, update, deleteById, import, template | 增删改导入仅 admin |
| 专业/班级/学生/教师/课程/开课/培养方案 | 同上模式：findAll、findById、findBySearch、findByPage；add、update、deleteById、import、template | 写操作与导入仅 admin |
| 年级学期 | /gradeLevel/* ，/term/* | 同上 |

### 8.3 成绩相关

| 接口 | 方法 | 功能 | 权限 |
|------|------|------|------|
| /grade/upload | POST | 上传成绩单 Excel | admin 全部；dean 本院；teacher 任课 |
| /grade/records | GET | 导入记录列表 | 按角色过滤 |
| /grade/download/{id} | GET | 下载某次导入文件 | 按权限 |
| /grade/query | POST | 成绩查询（分页、筛选） | admin 全部；dean 本院；teacher 任课；学生仅本人且 PUBLISHED |
| /grade/publish | POST | 发布成绩（UPLOADED→PUBLISHED） | 仅 admin |
| /grade/lock | POST | 锁定成绩（PUBLISHED→LOCKED） | 仅 admin |
| /grade/reexamination/* | POST | 强制修正（仅 LOCKED） | 仅 admin |
| /gradeChangeRequest/submit | POST | 提交成绩修改申请 | 教师/院长/admin（按课程权限） |
| /gradeChangeRequest/deanApprove | POST | 院长一级审批 | 院长（本院） |
| /gradeChangeRequest/adminApprove | POST | 管理员终审 | 仅 admin |

### 8.4 试卷分析

| 接口 | 方法 | 功能 | 权限 |
|------|------|------|------|
| /paper/upload | POST | 上传试卷分析文件 | 教师、admin |
| /paper/findBySearch | POST | 按文件名、上传人查询 | 教师本人/院长本院/admin 全部 |
| /paper/download/{id} | GET | 下载文件 | 同上 |
| /paper/deleteById | GET | 删除记录 | 仅 admin |

### 8.5 其它

| 接口 | 说明 | 权限 |
|------|------|------|
| /info/getCurrentTerm | 当前学期名称 | 无 |
| /info/getCurrentTermInfo | 当前学期对象 | 无 |
| /info/getForbidCourseSelection | 是否禁止选课 | 无 |
| /operationLog/* | 操作日志查询 | admin/教师/院长按角色 |

前端请求需在 Header 中携带：**Operator**（操作人姓名）、**UserType**（admin/dean/teacher）、**DepartmentId**（院长/教师时可选），以便拦截器做权限判断。

---

## 九、备份与恢复

### 9.1 数据库备份

- **全库**：`mysqldump -u root -p studentms > studentms_$(date +%Y%m%d).sql`（Linux）；Windows 下同命令，日期可用批处理或手动命名。
- **建议**：定期（如每日）备份；保留最近 N 份；备份文件存于安全目录。

### 9.2 成绩数据恢复

- **单表恢复**：若仅恢复 score / grade_change_log 等，可从全库备份中提取对应表 SQL 执行，或先备份当前库再导入历史备份中的表。
- **误删/误改**：优先从 grade_change_log 追溯变更历史；必要时从备份中恢复 score 表再重放后续审批记录（需人工核对）。

---

## 十、异常处理（QA）

| 场景 | 处理建议 |
|------|----------|
| **导入失败：表头校验不通过** | 检查课程名称、学期名称、任课教师、开课班级等与系统完全一致；学期、课程、开课信息需先在基础数据与教学管理中维护。 |
| **导入失败：学号不存在** | 检查学生是否已导入且学号与 Excel 一致（无空格、大小写）。 |
| **导入失败：学号+课程+学期已存在** | 不允许覆盖；提示使用「成绩修改申请」流程。 |
| **接口 403 / 权限不足** | 检查前端是否传 Operator、UserType、DepartmentId；确认当前角色是否有该接口权限（见 AdminInterceptor 与各 Controller）。 |
| **审批异常：管理员无法审批** | 确认申请状态为 PENDING（或 DEAN_APPROVED，若实现支持）；仅 admin 可终审。 |
| **学生看不到成绩** | 确认成绩已「发布」为 PUBLISHED；学生端仅查 PUBLISHED。 |
| **文件上传失败** | 检查 file.upload.path 目录存在且可写；单文件大小不超过 50MB（application.yml）。 |

---

**文档结束。** 若与最新代码不一致，以代码与数据库脚本为准。
